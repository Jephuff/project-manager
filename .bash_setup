#!/bin/bash
function prj-cd {
  . prj-export-variables

  if [ ! -d "$WORKING_DIR" ]; then
    echo "working directory not set"
    exit
  fi

  if [ ! -d "$ARCHIVE_DIR" ]; then
    echo "archive directory not set"
    exit
  fi

  if [ -d "$WORKING_DIR$1" ]; then
    cd $WORKING_DIR$1
  elif [ -d "$ARCHIVE_DIR$1" ]; then
    cd $ARCHIVE_DIR$1
  else
    echo "project doesn't exists"
  fi
}

function prj-start {
  . prj-export-variables

  if [ ! -d "$WORKING_DIR" ]; then
    echo "working directory not set"
    exit
  fi

  if [ ! -d "$ARCHIVE_DIR" ]; then
    echo "archive directory not set"
    exit
  fi

  if [ -d "$WORKING_DIR$1" ]; then
    cd "$WORKING_DIR$1"
  elif [ -d "$ARCHIVE_DIR$1" ]; then
    cd "$ARCHIVE_DIR$1"
  else
    echo "project doesn't exists"
    exit
  fi

  if [ $EDITOR == 'sublime' ]; then
    if hash sublime 2>/dev/null; then
      sublime "$SUBLIME_DIR$1.sublime-project" &
    elif hash subl 2>/dev/null; then
      subl "$SUBLIME_DIR$1.sublime-project" &
    else
      echo "could not find sublime command"
    fi
  elif [ $EDITOR == 'atom' ]; then
    if hash atom 2>/dev/null; then
      atom . &
    else
      echo "no atom command"
    fi
  fi

  if [ $GIT_CLIENT == 'source tree' ]; then
    if hash stree 2>/dev/null; then
      stree "$git_folder" &
    else
      echo "no git client found"
    fi
  fi

  while read -r script; do
    if hash osascript 2>/dev/null; then
      osascript -e 'activate application \"iTerm\"'
      osascript -e 'tell application \"System Events\" to keystroke \"t\" using command down'
      osascript -e 'tell application \"iTerm\" to tell session -1 of current terminal to write text \"$script\"'
    else
      $script
    fi
  done < ".config/new-tab-commands"

  

  ./start.sh
}

###Completion
_prj-name (){
  . prj-export-variables
  COMPREPLY=()
  if [ $3 = "prj-start" -o $3 = "prj-cd" -o $3 = "prj-archive" -o $3 = "prj-remove" -o $3 = "prj-restore" ]; then
    COMPREPLY=( $( compgen -W "$({ ls "$WORKING_DIR" ; ls "$ARCHIVE_DIR" ; })" -- ${COMP_WORDS[COMP_CWORD]} ) )
  fi
  return 0
}

complete -F _prj-name prj-start
complete -F _prj-name prj-cd
complete -F _prj-name prj-archive
complete -F _prj-name prj-remove
complete -F _prj-name prj-restore

export PATH=$PATH:$1/commands
